
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - SDG On-Call Assistant</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üìä</text></svg>">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Amazon Ember', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
            padding: 20px 0;
        }

        h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .subtitle {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .back-button {
            display: inline-block;
            background: rgba(255,255,255,0.2);
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            text-decoration: none;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        .back-button:hover {
            background: rgba(255,255,255,0.3);
        }

        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            text-align: center;
        }

        .card-icon {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .card-value {
            font-size: 2.5em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }

        .card-label {
            color: #666;
            font-size: 0.95em;
        }

        .chart-container {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
        }

        .chart-container h2 {
            color: #232f3e;
            margin-bottom: 20px;
        }

        .table-container {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: #f8f9fa;
            padding: 12px;
            text-align: left;
            font-weight: bold;
            color: #232f3e;
            border-bottom: 2px solid #dee2e6;
            cursor: pointer;
            user-select: none;
        }

        th:hover {
            background: #e9ecef;
        }

        td {
            padding: 12px;
            border-bottom: 1px solid #dee2e6;
            color: #666;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .export-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        .export-button:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .filters {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .filters label {
            color: #232f3e;
            font-weight: bold;
        }

        .filters input {
            padding: 8px 12px;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            font-size: 0.95em;
        }

        .loading {
            text-align: center;
            color: white;
            font-size: 1.2em;
            padding: 40px;
        }

        .program-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: bold;
            color: white;
        }

        .badge-paneu { background: #667eea; }
        .badge-fba { background: #764ba2; }
        .badge-sfp { background: #f093fb; }
        .badge-inventory { background: #4facfe; }
        .badge-transparency { background: #43e97b; }
        .badge-brand { background: #fa709a; }
        .badge-listings { background: #fee140; color: #232f3e; }
        .badge-sponsored { background: #30cfd0; }
        .badge-deals { background: #a8edea; color: #232f3e; }
        .badge-helpdesk { background: #ff6b6b; }
    </style>
</head>
<body>
    <div class="container">
        <a href="/" class="back-button">‚Üê Back to Main Portal</a>
        
        <header>
            <h1>üìä Admin Dashboard</h1>
            <p class="subtitle">SDG On-Call Assistant Analytics</p>
        </header>

        <div id="loading" class="loading">Loading analytics data...</div>

        <div id="dashboard" style="display: none;">
            <!-- Summary Cards -->
            <div class="summary-cards">
                <div class="card">
                    <div class="card-icon">üéØ</div>
                    <div class="card-value" id="total-clicks">0</div>
                    <div class="card-label">Total Program Clicks</div>
                </div>
                <div class="card">
                    <div class="card-icon">üë•</div>
                    <div class="card-value" id="total-visits">0</div>
                    <div class="card-label">Total Site Visits</div>
                </div>
                <div class="card">
                    <div class="card-icon">üèÜ</div>
                    <div class="card-value" id="top-program">-</div>
                    <div class="card-label">Most Popular Program</div>
                </div>
                <div class="card">
                    <div class="card-icon">üìÖ</div>
                    <div class="card-value" id="days-active">0</div>
                    <div class="card-label">Days Active</div>
                </div>
            </div>

            <!-- Chart -->
            <div class="chart-container">
                <h2>üìà Program Clicks Over Time (Last 30 Days)</h2>
                <canvas id="programChart"></canvas>
            </div>

            <!-- Filters -->
            <div class="filters">
                <label>Filter by Date:</label>
                <input type="date" id="start-date">
                <label>to</label>
                <input type="date" id="end-date">
                <button class="export-button" onclick="applyFilters()">Apply Filter</button>
                <button class="export-button" onclick="clearFilters()">Clear</button>
            </div>

            <!-- Export Button -->
            <button class="export-button" onclick="exportToCSV()">üì• Export to CSV</button>

            <!-- Table -->
            <div class="table-container">
                <h2>üìã Daily Program Breakdown</h2>
                <table id="stats-table">
                    <thead>
                        <tr>
                            <th onclick="sortTable(0)">Date ‚ñº</th>
                            <th onclick="sortTable(1)">Program ‚ñº</th>
                            <th onclick="sortTable(2)">Clicks ‚ñº</th>
                        </tr>
                    </thead>
                    <tbody id="table-body">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        let allData = [];
        let filteredData = [];
        let chart = null;

        const programNames = {
            paneu: 'Pan-EU',
            fba: 'FBA',
            sfp: 'Seller-Fulfilled Prime',
            inventory: 'Inventory Health',
            transparency: 'Transparency',
            brand: 'Brand Owners',
            listings: 'Listings',
            sponsored: 'Sponsored Products',
            deals: 'Deals and Coupons',
            helpdesk: 'SIM-Bank & Help Desk'
        };

        const programColors = {
            paneu: '#667eea',
            fba: '#764ba2',
            sfp: '#f093fb',
            inventory: '#4facfe',
            transparency: '#43e97b',
            brand: '#fa709a',
            listings: '#fee140',
            sponsored: '#30cfd0',
            deals: '#a8edea',
            helpdesk: '#ff6b6b'
        };

        async function loadDashboard() {
            try {
                const response = await fetch('/admin-stats');
                const data = await response.json();
                
                allData = data.program_daily_stats;
                filteredData = allData;
                
                updateSummaryCards(data);
                renderChart(data);
                renderTable(filteredData);
                
                document.getElementById('loading').style.display = 'none';
                document.getElementById('dashboard').style.display = 'block';
            } catch (error) {
                console.error('Failed to load dashboard:', error);
                document.getElementById('loading').textContent = 'Failed to load analytics data';
            }
        }

        function updateSummaryCards(data) {
            // Total clicks
            const totalClicks = Object.values(data.total_clicks || {})
                .filter(v => typeof v === 'number')
                .reduce((a, b) => a + b, 0);
            document.getElementById('total-clicks').textContent = totalClicks;
            
            // Total visits
            document.getElementById('total-visits').textContent = data.total_visits;
            
            // Top program
            const clicks = data.total_clicks || {};
            delete clicks._id;
            const topProgram = Object.entries(clicks)
                .sort((a, b) => b[1] - a[1])[0];
            if (topProgram) {
                document.getElementById('top-program').textContent = programNames[topProgram[0]] || topProgram[0];
            }
            
            // Days active
            const dates = [...new Set(data.program_daily_stats.map(s => s.date))];
            document.getElementById('days-active').textContent = dates.length;
        }

        function renderChart(data) {
            const ctx = document.getElementById('programChart').getContext('2d');
            
            // Prepare data for chart
            const dates = [...new Set(data.program_daily_stats.map(s => s.date))].sort();
            const programs = Object.keys(programNames);
            
            const datasets = programs.map(program => {
                const programData = dates.map(date => {
                    const stat = data.program_daily_stats.find(s => s.date === date && s.program === program);
                    return stat ? stat.clicks : 0;
                });
                
                return {
                    label: programNames[program],
                    data: programData,
                    borderColor: programColors[program],
                    backgroundColor: programColors[program] + '20',
                    tension: 0.4
                };
            });
            
            if (chart) {
                chart.destroy();
            }
            
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }

        function renderTable(data) {
            const tbody = document.getElementById('table-body');
            tbody.innerHTML = '';
            
            data.forEach(stat => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${stat.date}</td>
                    <td><span class="program-badge badge-${stat.program}">${programNames[stat.program] || stat.program}</span></td>
                    <td>${stat.clicks}</td>
                `;
            });
        }

        function sortTable(columnIndex) {
            const sortKey = ['date', 'program', 'clicks'][columnIndex];
            
            filteredData.sort((a, b) => {
                if (sortKey === 'clicks') {
                    return b[sortKey] - a[sortKey];
                }
                return a[sortKey] > b[sortKey] ? -1 : 1;
            });
            
            renderTable(filteredData);
        }

        function applyFilters() {
            const startDate = document.getElementById('start-date').value;
            const endDate = document.getElementById('end-date').value;
            
            if (startDate && endDate) {
                filteredData = allData.filter(stat => 
                    stat.date >= startDate && stat.date <= endDate
                );
            } else {
                filteredData = allData;
            }
            
            renderTable(filteredData);
        }

        function clearFilters() {
            document.getElementById('start-date').value = '';
            document.getElementById('end-date').value = '';
            filteredData = allData;
            renderTable(filteredData);
        }

        function exportToCSV() {
            const headers = ['Date', 'Program', 'Clicks'];
            const rows = filteredData.map(stat => [
                stat.date,
                programNames[stat.program] || stat.program,
                stat.clicks
            ]);
            
            let csv = headers.join(',') + '
';
            rows.forEach(row => {
                csv += row.join(',') + '
';
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `sdg-analytics-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
        }

        // Load dashboard on page load
        loadDashboard();
        
        // Auto-refresh every 30 seconds
        setInterval(loadDashboard, 30000);
    </script>
</body>
</html>

